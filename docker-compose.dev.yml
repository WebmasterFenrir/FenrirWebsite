services:
  nginx-proxy:
    image: nginxproxy/nginx-proxy:alpine
    container_name: nginx-proxy-dev
    ports:
      - "80:80"
    volumes:
      - html-dev:/usr/share/nginx/html
      - /var/run/docker.sock:/tmp/docker.sock:ro
    networks:
      - proxy-net
    restart: unless-stopped

  site:
    build: .
    container_name: fenrir-site-dev
    environment:
      - VIRTUAL_HOST=fenrir.local,www.fenrir.local
    networks:
      - proxy-net
    restart: unless-stopped
    volumes:
      - .:/app
    command: ["sh", "-c", "npm install && npm run dev -- --host"]

  pocketbase:
    image: ghcr.io/muchobien/pocketbase:latest
    container_name: pocketbase-dev
    environment:
      PB_PORT: 3000
      PB_ADMIN_EMAIL: ${PB_ADMIN_EMAIL:-admin@local.dev}
      PB_ADMIN_PASSWORD: ${PB_ADMIN_PASSWORD:-password}
      TZ: Europe/Berlin
    ports:
      - "3000:3000"
    volumes:
      - ./pb_data:/pb_data
    restart: unless-stopped

  feedback-api:
    image: oven/bun:1.1.30-alpine
    container_name: feedback-api-dev
    working_dir: /workspace/src/apps/feedback-api
    command: ["sh", "-c", "bun run start:${FEEDBACK_MODE:-feedback}"]
    environment:
      FEEDBACK_MODE: ${FEEDBACK_MODE:-feedback}
      N8N_WEBHOOK_URL: ${N8N_WEBHOOK_URL:-http://host.docker.internal:5678/webhook/feedback}
      FEEDBACK_API_PORT: ${FEEDBACK_API_PORT:-3000}
    ports:
      - "${FEEDBACK_API_PORT:-3000}:${FEEDBACK_API_PORT:-3000}"
    volumes:
      - .:/workspace
    networks:
      - proxy-net
    restart: unless-stopped

  feedback-website:
    image: node:20-alpine
    container_name: feedback-website-dev
    working_dir: /workspace/src/apps/feedback-website
    command: ["sh", "-c", "npm install -g serve && serve -l ${FEEDBACK_WEBSITE_PORT:-4173} public"]
    environment:
      FEEDBACK_WEBSITE_PORT: ${FEEDBACK_WEBSITE_PORT:-4173}
    ports:
      - "${FEEDBACK_WEBSITE_PORT:-4173}:${FEEDBACK_WEBSITE_PORT:-4173}"
    volumes:
      - .:/workspace
    networks:
      - proxy-net
    restart: unless-stopped

networks:
  proxy-net:

volumes:
  html-dev:
